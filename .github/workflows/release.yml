name: Release

on:
  push:
    branches: [master]

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    outputs:
      published: ${{ steps.changesets.outputs.published }}
      publishedPackages: ${{ steps.changesets.outputs.publishedPackages }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_ACCESS_TOKEN }}

      - uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          version: pnpm changeset version
          publish: pnpm changeset tag
          commit: "ci: release"
          title: "ci: release"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}

      - name: Push to release branch
        if: steps.changesets.outputs.published == 'true'
        run: |
          git push origin master:production
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}

  build-server:
    name: Build server binaries
    needs: release
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"

      - name: Check if server was published
        id: check-server
        run: |
          published='${{ needs.release.outputs.publishedPackages }}'
          echo "Published packages: $published"

          if [ "$published" != "false" ] && [ -n "$published" ]; then
            if echo "$published" | jq -e 'map(select(.name == "server")) | length > 0' > /dev/null; then
              echo "server_published=true" >> $GITHUB_OUTPUT
              version=$(echo "$published" | jq -r 'map(select(.name == "server"))[0].version')
              echo "version=$version" >> $GITHUB_OUTPUT
            else
              echo "server_published=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "server_published=false" >> $GITHUB_OUTPUT
          fi

      - name: Create dist directory
        if: steps.check-server.outputs.server_published == 'true'
        run: mkdir -p dist

      - name: Build binary
        if: steps.check-server.outputs.server_published == 'true'
        working-directory: apps/server
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          output_name="oto-${{ matrix.goos }}-${{ matrix.goarch }}"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            output_name="${output_name}.exe"
          fi
          go build -o "../../dist/${output_name}" ./cmd/api

      - name: Upload artifact
        if: steps.check-server.outputs.server_published == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: oto-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/*
          retention-days: 1

  upload-server-assets:
    name: Upload server assets
    needs: [release, build-server]
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check if server was published
        id: check-server
        run: |
          published='${{ needs.release.outputs.publishedPackages }}'
          if [ "$published" != "false" ] && [ -n "$published" ]; then
            if echo "$published" | jq -e 'map(select(.name == "server")) | length > 0' > /dev/null; then
              echo "server_published=true" >> $GITHUB_OUTPUT
              version=$(echo "$published" | jq -r 'map(select(.name == "server"))[0].version')
              echo "version=$version" >> $GITHUB_OUTPUT
            else
              echo "server_published=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "server_published=false" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        if: steps.check-server.outputs.server_published == 'true'
        uses: actions/download-artifact@v7
        with:
          path: dist
          pattern: oto-*
          merge-multiple: true

      - name: Create Release
        if: steps.check-server.outputs.server_published == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: server@${{ steps.check-server.outputs.version }}
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
